/*
 *  Receives an array of string and sort it according to byte
 * values. Lowercase after uppercase
 */
var sort_bytes = function(input, cb) {
  var res_tmp = []
  var res = []
 
  //convert to bytes
  input.forEach(function(str){
    var tmp = []
    for(var i=0; i<str.length; i++) {
      tmp.push(str.charCodeAt(i)) 
    }
    res_tmp[str] = tmp
  })

  //sort by bytes
  var bytes = [] 
  for(var key in res_tmp) {
    bytes.push(res_tmp[key])
  }
   
  bytes.sort() 

  //push sorted results to array
  bytes.forEach(function(chunk) {
    var tmp_str = ""
    for(var i=0; i<chunk.length; i++){
      tmp_str+=(String.fromCharCode(chunk[i]))
    }
    res.push(tmp_str)
  })

  cb(res)
}

/*
 *  Creates signature based on sorted array
 */ 
var transform_str = function(input, cb) {
  var res = "GET\nwebservices.amazon.com\n/onca/xml"
  
  input.forEach(function(str){
    res+=str
  })

  cb(input)
}

var sign = function(url, cb) {
  var input = url.split('?')[1].split('&')

  sort_bytes(input, function(sorted){
    transform_str(sorted, function(str){
      cb(str)
    })
  })  
}

exports.sign = sign
